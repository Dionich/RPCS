<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Радар: Візуалізація цілей</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #radar-plot {
            width: 600px;
            height: 600px;
        }

        #controls {
            margin-top: 20px;
        }

        label {
            margin-right: 10px;
        }

        input {
            margin-right: 20px;
        }

        button {
            padding: 5px 10px;
        }
    </style>
</head>

<body>
    <h1>Візуалізація вимірювань радару</h1>
    <div id="radar-plot"></div>
    <div id="controls">
        <h3>Налаштування параметрів</h3>
        <label>Вимірювань на оберт:</label>
        <input type="number" id="measurementsPerRotation" value="360">
        <label>Швидкість обертання (RPM):</label>
        <input type="number" id="rotationSpeed" value="60">
        <label>Швидкість цілей (км/год):</label>
        <input type="number" id="targetSpeed" value="100">
        <button onclick="updateConfig()">Оновити</button>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:4000');
        const c = 300000; // Швидкість світла, км/с
        let targets = [];
        let isPlotInitialized = false; // Флаг для ініціалізації графіку

        socket.onopen = () => {
            console.log('Підключено до WebSocket сервера');
            initializePlot(); // Ініціалізація порожнього графіку при підключенні
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('Отримані дані:', data);
                processRadarData(data);
            } catch (error) {
                console.error('Помилка парсингу JSON:', error);
            }
        };

        socket.onclose = () => {
            console.log('З\'єднання закрито');
        };

        socket.onerror = (error) => {
            console.error('Помилка WebSocket:', error);
        };

        function initializePlot() {
            const layout = {
                polar: {
                    radialaxis: { title: 'Відстань (км)', range: [0, 200] },
                    angularaxis: { rotation: 90, direction: 'clockwise' }
                },
                showlegend: false
            };
            Plotly.newPlot('radar-plot', [], layout);
            isPlotInitialized = true;
        }

        function processRadarData(data) {
            const scanAngle = data.scanAngle;
            const echoResponses = data.echoResponses || [];

            console.log('echoResponses:', echoResponses);

            // Додаємо нові цілі до масиву, зберігаючи старі
            echoResponses.forEach(response => {
                const time = response.time;
                const power = response.power;
                if (time && power !== undefined) {
                    const distance = (c * time) / 2;
                    console.log('Ціль:', { r: distance, theta: scanAngle, power });
                    targets.push({
                        r: distance,
                        theta: scanAngle,
                        power: power
                    });
                } else {
                    console.warn('Некоректні дані цілі:', response);
                }
            });

            // Обмежуємо кількість точок, щоб уникнути перевантаження
            if (targets.length > 1000) {
                targets = targets.slice(-1000); // Зберігаємо останні 1000 точок
            }

            updatePlot();
        }

        function updatePlot() {
            console.log('Оновлення графіку з даними:', targets);
            const trace = {
                type: 'scatterpolar',
                r: targets.map(t => t.r),
                theta: targets.map(t => t.theta),
                mode: 'markers',
                marker: {
                    size: 10,
                    color: targets.map(t => t.power),
                    colorscale: 'Viridis',
                    showscale: true, // Завжди показувати кольорову шкалу
                    cmin: 0,
                    cmax: 1
                }
            };

            const layout = {
                polar: {
                    radialaxis: { title: 'Відстань (км)', range: [0, 200] },
                    angularaxis: { rotation: 90, direction: 'clockwise' }
                },
                showlegend: false
            };

            if (!isPlotInitialized) {
                Plotly.newPlot('radar-plot', [trace], layout);
                isPlotInitialized = true;
            } else {
                Plotly.react('radar-plot', [trace], layout); // Плавне оновлення
            }
        }

        function updateConfig() {
            const config = {
                measurementsPerRotation: parseInt(document.getElementById('measurementsPerRotation').value),
                rotationSpeed: parseInt(document.getElementById('rotationSpeed').value),
                targetSpeed: parseInt(document.getElementById('targetSpeed').value)
            };

            fetch('http://localhost:4000/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
                .then(response => response.json())
                .then(data => console.log('Параметри оновлено:', data))
                .catch(error => console.error('Помилка API:', error));
        }
    </script>
</body>

</html>